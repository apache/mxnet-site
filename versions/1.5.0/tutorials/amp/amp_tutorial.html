<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta content="Using AMP (Automatic Mixed Precision) in MXNet" property="og:title">
<meta content="https://raw.githubusercontent.com/dmlc/web-data/master/mxnet/image/og-logo.png" property="og:image">
<meta content="https://raw.githubusercontent.com/dmlc/web-data/master/mxnet/image/og-logo.png" property="og:image:secure_url">
<meta content="Using AMP (Automatic Mixed Precision) in MXNet" property="og:description"/>
<title>Using AMP (Automatic Mixed Precision) in MXNet — mxnet  documentation</title>
<link crossorigin="anonymous" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" rel="stylesheet"/>
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet"/>
<link href="../../_static/basic.css" rel="stylesheet" type="text/css">
<link href="../../_static/pygments.css" rel="stylesheet" type="text/css">
<link href="../../_static/mxnet.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
<script src="https://code.jquery.com/jquery-1.11.1.min.js" type="text/javascript"></script>
<script src="../../_static/underscore.js" type="text/javascript"></script>
<script src="../../_static/searchtools_custom.js" type="text/javascript"></script>
<script src="../../_static/doctools.js" type="text/javascript"></script>
<script src="../../_static/selectlang.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
<script type="text/javascript"> jQuery(function() { Search.loadIndex("/versions/1.5.0/searchindex.js"); Search.init();}); </script>
<script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new
      Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-96378503-1', 'auto');
      ga('send', 'pageview');

    </script>
<!-- -->
<!-- <script type="text/javascript" src="../../_static/jquery.js"></script> -->
<!-- -->
<!-- <script type="text/javascript" src="../../_static/underscore.js"></script> -->
<!-- -->
<!-- <script type="text/javascript" src="../../_static/doctools.js"></script> -->
<!-- -->
<!-- <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> -->
<!-- -->
<link href="../../genindex.html" rel="index" title="Index">
<link href="../../search.html" rel="search" title="Search"/>
<link href="index.html" rel="up" title="Tutorials"/>
<link href="../../install/ubuntu_setup.html" rel="next" title="Installing MXNet on Ubuntu"/>
<link href="index.html" rel="prev" title="Tutorials"/>
<link href="https://raw.githubusercontent.com/dmlc/web-data/master/mxnet/image/mxnet-icon.png" rel="icon" type="image/png"/>
</link></link></link></meta></meta></meta></head>
<body background="https://raw.githubusercontent.com/dmlc/web-data/master/mxnet/image/mxnet-background-compressed.jpeg" role="document">
<div class="content-block"><div class="navbar navbar-fixed-top">
<div class="container" id="navContainer">
<div class="innder" id="header-inner">
<h1 id="logo-wrap">
<a href="../../" id="logo"><img src="https://raw.githubusercontent.com/dmlc/web-data/master/mxnet/image/mxnet_logo.png"/></a>
</h1>
<nav class="nav-bar" id="main-nav">
<a class="main-nav-link" href="/versions/1.5.0/install/index.html">Install</a>
<span id="dropdown-menu-position-anchor">
<a aria-expanded="true" aria-haspopup="true" class="main-nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button">Gluon <span class="caret"></span></a>
<ul class="dropdown-menu navbar-menu" id="package-dropdown-menu">
<li><a class="main-nav-link" href="/versions/1.5.0/tutorials/gluon/gluon.html">About</a></li>
<li><a class="main-nav-link" href="https://www.d2l.ai/">Dive into Deep Learning</a></li>
<li><a class="main-nav-link" href="https://gluon-cv.mxnet.io">GluonCV Toolkit</a></li>
<li><a class="main-nav-link" href="https://gluon-nlp.mxnet.io/">GluonNLP Toolkit</a></li>
</ul>
</span>
<span id="dropdown-menu-position-anchor">
<a aria-expanded="true" aria-haspopup="true" class="main-nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button">API <span class="caret"></span></a>
<ul class="dropdown-menu navbar-menu" id="package-dropdown-menu">
<li><a class="main-nav-link" href="/versions/1.5.0/api/python/index.html">Python</a></li>
<li><a class="main-nav-link" href="/versions/1.5.0/api/c++/index.html">C++</a></li>
<li><a class="main-nav-link" href="/versions/1.5.0/api/clojure/index.html">Clojure</a></li>
<li><a class="main-nav-link" href="/versions/1.5.0/api/java/index.html">Java</a></li>
<li><a class="main-nav-link" href="/versions/1.5.0/api/julia/index.html">Julia</a></li>
<li><a class="main-nav-link" href="/versions/1.5.0/api/perl/index.html">Perl</a></li>
<li><a class="main-nav-link" href="/versions/1.5.0/api/r/index.html">R</a></li>
<li><a class="main-nav-link" href="/versions/1.5.0/api/scala/index.html">Scala</a></li>
</ul>
</span>
<span id="dropdown-menu-position-anchor-docs">
<a aria-expanded="true" aria-haspopup="true" class="main-nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button">Docs <span class="caret"></span></a>
<ul class="dropdown-menu navbar-menu" id="package-dropdown-menu-docs">
<li><a class="main-nav-link" href="/versions/1.5.0/faq/index.html">FAQ</a></li>
<li><a class="main-nav-link" href="/versions/1.5.0/tutorials/index.html">Tutorials</a>
<li><a class="main-nav-link" href="https://github.com/apache/incubator-mxnet/tree/1.5.0/example">Examples</a></li>
<li><a class="main-nav-link" href="/versions/1.5.0/architecture/index.html">Architecture</a></li>
<li><a class="main-nav-link" href="https://cwiki.apache.org/confluence/display/MXNET/Apache+MXNet+Home">Developer Wiki</a></li>
<li><a class="main-nav-link" href="/versions/1.5.0/model_zoo/index.html">Model Zoo</a></li>
<li><a class="main-nav-link" href="https://github.com/onnx/onnx-mxnet">ONNX</a></li>
</li></ul>
</span>
<span id="dropdown-menu-position-anchor-community">
<a aria-expanded="true" aria-haspopup="true" class="main-nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button">Community <span class="caret"></span></a>
<ul class="dropdown-menu navbar-menu" id="package-dropdown-menu-community">
<li><a class="main-nav-link" href="http://discuss.mxnet.io">Forum</a></li>
<li><a class="main-nav-link" href="https://github.com/apache/incubator-mxnet/tree/1.5.0">Github</a></li>
<li><a class="main-nav-link" href="/versions/1.5.0/community/contribute.html">Contribute</a></li>
<li><a class="main-nav-link" href="/versions/1.5.0/community/ecosystem.html">Ecosystem</a></li>
<li><a class="main-nav-link" href="/versions/1.5.0/community/powered_by.html">Powered By</a></li>
</ul>
</span>
<span id="dropdown-menu-position-anchor-version" style="position: relative"><a href="#" class="main-nav-link dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="true">1.5.0<span class="caret"></span></a><ul id="package-dropdown-menu" class="dropdown-menu"><li><a href="/">master</a></li><li><a href="/versions/1.7.0/">1.7.0</a></li><li><a href=/versions/1.6.0/>1.6.0</a></li><li><a href=/versions/1.5.0/>1.5.0</a></li><li><a href=/versions/1.4.1/>1.4.1</a></li><li><a href=/versions/1.3.1/>1.3.1</a></li><li><a href=/versions/1.2.1/>1.2.1</a></li><li><a href=/versions/1.1.0/>1.1.0</a></li><li><a href=/versions/1.0.0/>1.0.0</a></li><li><a href=/versions/0.12.1/>0.12.1</a></li><li><a href=/versions/0.11.0/>0.11.0</a></li></ul></span></nav>
<script> function getRootPath(){ return "../../" } </script>
<div class="burgerIcon dropdown">
<a class="dropdown-toggle" data-toggle="dropdown" href="#" role="button">☰</a>
<ul class="dropdown-menu" id="burgerMenu">
<li><a href="/versions/1.5.0/install/index.html">Install</a></li>
<li><a class="main-nav-link" href="/versions/1.5.0/tutorials/index.html">Tutorials</a></li>
<li class="dropdown-submenu dropdown">
<a aria-expanded="true" aria-haspopup="true" class="dropdown-toggle burger-link" data-toggle="dropdown" href="#" tabindex="-1">Gluon</a>
<ul class="dropdown-menu navbar-menu" id="package-dropdown-menu">
<li><a class="main-nav-link" href="/versions/1.5.0/tutorials/gluon/gluon.html">About</a></li>
<li><a class="main-nav-link" href="http://gluon.mxnet.io">The Straight Dope (Tutorials)</a></li>
<li><a class="main-nav-link" href="https://gluon-cv.mxnet.io">GluonCV Toolkit</a></li>
<li><a class="main-nav-link" href="https://gluon-nlp.mxnet.io/">GluonNLP Toolkit</a></li>
</ul>
</li>
<li class="dropdown-submenu">
<a aria-expanded="true" aria-haspopup="true" class="dropdown-toggle burger-link" data-toggle="dropdown" href="#" tabindex="-1">API</a>
<ul class="dropdown-menu">
<li><a class="main-nav-link" href="/versions/1.5.0/api/python/index.html">Python</a></li>
<li><a class="main-nav-link" href="/versions/1.5.0/api/c++/index.html">C++</a></li>
<li><a class="main-nav-link" href="/versions/1.5.0/api/clojure/index.html">Clojure</a></li>
<li><a class="main-nav-link" href="/versions/1.5.0/api/java/index.html">Java</a></li>
<li><a class="main-nav-link" href="/versions/1.5.0/api/julia/index.html">Julia</a></li>
<li><a class="main-nav-link" href="/versions/1.5.0/api/perl/index.html">Perl</a></li>
<li><a class="main-nav-link" href="/versions/1.5.0/api/r/index.html">R</a></li>
<li><a class="main-nav-link" href="/versions/1.5.0/api/scala/index.html">Scala</a></li>
</ul>
</li>
<li class="dropdown-submenu">
<a aria-expanded="true" aria-haspopup="true" class="dropdown-toggle burger-link" data-toggle="dropdown" href="#" tabindex="-1">Docs</a>
<ul class="dropdown-menu">
<li><a href="/versions/1.5.0/faq/index.html" tabindex="-1">FAQ</a></li>
<li><a href="/versions/1.5.0/tutorials/index.html" tabindex="-1">Tutorials</a></li>
<li><a href="https://github.com/apache/incubator-mxnet/tree/1.5.0/example" tabindex="-1">Examples</a></li>
<li><a href="/versions/1.5.0/architecture/index.html" tabindex="-1">Architecture</a></li>
<li><a href="https://cwiki.apache.org/confluence/display/MXNET/Apache+MXNet+Home" tabindex="-1">Developer Wiki</a></li>
<li><a href="/versions/1.5.0/model_zoo/index.html" tabindex="-1">Gluon Model Zoo</a></li>
<li><a href="https://github.com/onnx/onnx-mxnet" tabindex="-1">ONNX</a></li>
</ul>
</li>
<li class="dropdown-submenu dropdown">
<a aria-haspopup="true" class="dropdown-toggle burger-link" data-toggle="dropdown" href="#" role="button" tabindex="-1">Community</a>
<ul class="dropdown-menu">
<li><a href="http://discuss.mxnet.io" tabindex="-1">Forum</a></li>
<li><a href="https://github.com/apache/incubator-mxnet/tree/1.5.0" tabindex="-1">Github</a></li>
<li><a href="/versions/1.5.0/community/contribute.html" tabindex="-1">Contribute</a></li>
<li><a href="/versions/1.5.0/community/ecosystem.html" tabindex="-1">Ecosystem</a></li>
<li><a href="/versions/1.5.0/community/powered_by.html" tabindex="-1">Powered By</a></li>
</ul>
</li>
<li id="dropdown-menu-position-anchor-version-mobile" class="dropdown-submenu" style="position: relative"><a href="#" tabindex="-1">1.5.0</a><ul class="dropdown-menu"><li><a tabindex="-1" href=/>master</a></li><li><a tabindex="-1" href=/versions/1.6.0/>1.6.0</a></li><li><a tabindex="-1" href=/versions/1.5.0/>1.5.0</a></li><li><a tabindex="-1" href=/versions/1.4.1/>1.4.1</a></li><li><a tabindex="-1" href=/versions/1.3.1/>1.3.1</a></li><li><a tabindex="-1" href=/versions/1.2.1/>1.2.1</a></li><li><a tabindex="-1" href=/versions/1.1.0/>1.1.0</a></li><li><a tabindex="-1" href=/versions/1.0.0/>1.0.0</a></li><li><a tabindex="-1" href=/versions/0.12.1/>0.12.1</a></li><li><a tabindex="-1" href=/versions/0.11.0/>0.11.0</a></li></ul></li></ul>
</div>
<div class="plusIcon dropdown">
<a class="dropdown-toggle" data-toggle="dropdown" href="#" role="button"><span aria-hidden="true" class="glyphicon glyphicon-plus"></span></a>
<ul class="dropdown-menu dropdown-menu-right" id="plusMenu"></ul>
</div>
<div id="search-input-wrap">
<form action="../../search.html" autocomplete="off" class="" method="get" role="search">
<div class="form-group inner-addon left-addon">
<i class="glyphicon glyphicon-search"></i>
<input class="form-control" name="q" placeholder="Search" type="text"/>
</div>
<input name="check_keywords" type="hidden" value="yes">
<input name="area" type="hidden" value="default"/>
</input></form>
<div id="search-preview"></div>
</div>
<div id="searchIcon">
<span aria-hidden="true" class="glyphicon glyphicon-search"></span>
</div>
<!-- <div id="lang-select-wrap"> -->
<!--   <label id="lang-select-label"> -->
<!--     <\!-- <i class="fa fa-globe"></i> -\-> -->
<!--     <span></span> -->
<!--   </label> -->
<!--   <select id="lang-select"> -->
<!--     <option value="en">Eng</option> -->
<!--     <option value="zh">中文</option> -->
<!--   </select> -->
<!-- </div> -->
<!--     <a id="mobile-nav-toggle">
        <span class="mobile-nav-toggle-bar"></span>
        <span class="mobile-nav-toggle-bar"></span>
        <span class="mobile-nav-toggle-bar"></span>
      </a> -->
</div>
</div>
</div>
<script type="text/javascript">
        $('body').css('background', 'white');
    </script>
<div class="container">
<div class="row">
<div aria-label="main navigation" class="sphinxsidebar leftsidebar" role="navigation">
<div class="sphinxsidebarwrapper">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">MXNet APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../architecture/index.html">MXNet Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../community/index.html">MXNet Community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq/index.html">MXNet FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gluon/index.html">About Gluon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/index.html">Installing MXNet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/index.html#nvidia-jetson-tx-family">Nvidia Jetson TX family</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install/index.html#source-download">Source Download</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_zoo/index.html">MXNet Model Zoo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Tutorials</a></li>
</ul>
</div>
</div>
<div class="content">
<div class="page-tracker"></div>
<!--- Licensed to the Apache Software Foundation (ASF) under one -->
<!--- or more contributor license agreements.  See the NOTICE file -->
<!--- distributed with this work for additional information -->
<!--- regarding copyright ownership.  The ASF licenses this file -->
<!--- to you under the Apache License, Version 2.0 (the -->
<!--- "License"); you may not use this file except in compliance -->
<!--- with the License.  You may obtain a copy of the License at --><!---   http://www.apache.org/licenses/LICENSE-2.0 --><!--- Unless required by applicable law or agreed to in writing, -->
<!--- software distributed under the License is distributed on an -->
<!--- "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY -->
<!--- KIND, either express or implied.  See the License for the -->
<!--- specific language governing permissions and limitations -->
<!--- under the License. --><div class="section" id="using-amp-automatic-mixed-precision-in-mxnet">
<span id="using-amp-automatic-mixed-precision-in-mxnet"></span><h1>Using AMP (Automatic Mixed Precision) in MXNet<a class="headerlink" href="#using-amp-automatic-mixed-precision-in-mxnet" title="Permalink to this headline">¶</a></h1>
<p>Training Deep Learning networks is a very computationally intensive task. Novel model architectures tend to have increasing number of layers and parameters, which slows down training. Fortunately, new generations of training hardware as well as software optimizations, make it a feasible task.</p>
<p>However, where most of the (both hardware and software) optimization opportunities exists is in exploiting lower precision (like FP16) to, for example, utilize Tensor Cores available on new Volta and Turing GPUs. While training in FP16 showed great success in image classification tasks, other more complicated neural networks typically stayed in FP32 due to difficulties in applying the FP16 training guidelines.</p>
<p>That is where AMP (Automatic Mixed Precision) comes into play. It automatically applies the guidelines of FP16 training, using FP16 precision where it provides the most benefit, while conservatively keeping in full FP32 precision operations unsafe to do in FP16.</p>
<p>This tutorial shows how to get started with mixed precision training using AMP for MXNet. As an example of a network we will use SSD network from GluonCV.</p>
<div class="section" id="data-loader-and-helper-functions">
<span id="data-loader-and-helper-functions"></span><h2>Data loader and helper functions<a class="headerlink" href="#data-loader-and-helper-functions" title="Permalink to this headline">¶</a></h2>
<p>For demonstration purposes we will use synthetic data loader.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">mxnet</span> <span class="kn">as</span> <span class="nn">mx</span>
<span class="kn">import</span> <span class="nn">mxnet.gluon</span> <span class="kn">as</span> <span class="nn">gluon</span>
<span class="kn">from</span> <span class="nn">mxnet</span> <span class="kn">import</span> <span class="n">autograd</span>
<span class="kn">import</span> <span class="nn">gluoncv</span> <span class="kn">as</span> <span class="nn">gcv</span>
<span class="kn">from</span> <span class="nn">gluoncv.model_zoo</span> <span class="kn">import</span> <span class="n">get_model</span>

<span class="n">data_shape</span> <span class="o">=</span> <span class="mi">512</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">lr</span> <span class="o">=</span> <span class="mf">0.001</span>
<span class="n">wd</span> <span class="o">=</span> <span class="mf">0.0005</span>
<span class="n">momentum</span> <span class="o">=</span> <span class="mf">0.9</span>

<span class="c1"># training contexts</span>
<span class="n">ctx</span> <span class="o">=</span> <span class="p">[</span><span class="n">mx</span><span class="o">.</span><span class="n">gpu</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span>

<span class="c1"># set up logger</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">()</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

<span class="n">ce_metric</span> <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span class="n">metric</span><span class="o">.</span><span class="n">Loss</span><span class="p">(</span><span class="s1">'CrossEntropy'</span><span class="p">)</span>
<span class="n">smoothl1_metric</span> <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span class="n">metric</span><span class="o">.</span><span class="n">Loss</span><span class="p">(</span><span class="s1">'SmoothL1'</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SyntheticDataLoader</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_shape</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SyntheticDataLoader</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch_size</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">data_shape</span><span class="p">,</span> <span class="n">data_shape</span><span class="p">)</span>
        <span class="n">cls_targets_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">6132</span><span class="p">)</span>
        <span class="n">box_targets_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">6132</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span class="n">nd</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">mx</span><span class="o">.</span><span class="n">cpu_pinned</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cls_targets</span> <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span class="n">nd</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">cls_targets_shape</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">mx</span><span class="o">.</span><span class="n">cpu_pinned</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">box_targets</span> <span class="o">=</span> <span class="n">mx</span><span class="o">.</span><span class="n">nd</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">box_targets_shape</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="n">mx</span><span class="o">.</span><span class="n">cpu_pinned</span><span class="p">())</span>
    
    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">>=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_size</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_size</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls_targets</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_targets</span><span class="p">]</span>
    
    <span class="n">__next__</span> <span class="o">=</span> <span class="nb">next</span>
    
    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>
    
<span class="n">train_data</span> <span class="o">=</span> <span class="n">SyntheticDataLoader</span><span class="p">(</span><span class="n">data_shape</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_network</span><span class="p">():</span>
    <span class="c1"># SSD with RN50 backbone</span>
    <span class="n">net_name</span> <span class="o">=</span> <span class="s1">'ssd_512_resnet50_v1_coco'</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">(</span><span class="n">record</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">w</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">"ignore"</span><span class="p">)</span>
        <span class="n">net</span> <span class="o">=</span> <span class="n">get_model</span><span class="p">(</span><span class="n">net_name</span><span class="p">,</span> <span class="n">pretrained_base</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">norm_layer</span><span class="o">=</span><span class="n">gluon</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm</span><span class="p">)</span>
        <span class="n">net</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
        <span class="n">net</span><span class="o">.</span><span class="n">collect_params</span><span class="p">()</span><span class="o">.</span><span class="n">reset_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">net</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="training-in-fp32">
<span id="training-in-fp32"></span><h1>Training in FP32<a class="headerlink" href="#training-in-fp32" title="Permalink to this headline">¶</a></h1>
<p>First, let us create the network.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">net</span> <span class="o">=</span> <span class="n">get_network</span><span class="p">()</span>
<span class="n">net</span><span class="o">.</span><span class="n">hybridize</span><span class="p">(</span><span class="n">static_alloc</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">static_shape</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Next, we need to create a Gluon Trainer.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">trainer</span> <span class="o">=</span> <span class="n">gluon</span><span class="o">.</span><span class="n">Trainer</span><span class="p">(</span>
    <span class="n">net</span><span class="o">.</span><span class="n">collect_params</span><span class="p">(),</span> <span class="s1">'sgd'</span><span class="p">,</span>
    <span class="p">{</span><span class="s1">'learning_rate'</span><span class="p">:</span> <span class="n">lr</span><span class="p">,</span> <span class="s1">'wd'</span><span class="p">:</span> <span class="n">wd</span><span class="p">,</span> <span class="s1">'momentum'</span><span class="p">:</span> <span class="n">momentum</span><span class="p">})</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">mbox_loss</span> <span class="o">=</span> <span class="n">gcv</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">SSDMultiBoxLoss</span><span class="p">()</span>

<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">ce_metric</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="n">smoothl1_metric</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">btic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_data</span><span class="p">):</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">gluon</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">split_and_load</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ctx_list</span><span class="o">=</span><span class="n">ctx</span><span class="p">,</span> <span class="n">batch_axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">cls_targets</span> <span class="o">=</span> <span class="n">gluon</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">split_and_load</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ctx_list</span><span class="o">=</span><span class="n">ctx</span><span class="p">,</span> <span class="n">batch_axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">box_targets</span> <span class="o">=</span> <span class="n">gluon</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">split_and_load</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ctx_list</span><span class="o">=</span><span class="n">ctx</span><span class="p">,</span> <span class="n">batch_axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">autograd</span><span class="o">.</span><span class="n">record</span><span class="p">():</span>
            <span class="n">cls_preds</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">box_preds</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">cls_pred</span><span class="p">,</span> <span class="n">box_pred</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="n">cls_preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cls_pred</span><span class="p">)</span>
                <span class="n">box_preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box_pred</span><span class="p">)</span>
            <span class="n">sum_loss</span><span class="p">,</span> <span class="n">cls_loss</span><span class="p">,</span> <span class="n">box_loss</span> <span class="o">=</span> <span class="n">mbox_loss</span><span class="p">(</span>
                <span class="n">cls_preds</span><span class="p">,</span> <span class="n">box_preds</span><span class="p">,</span> <span class="n">cls_targets</span><span class="p">,</span> <span class="n">box_targets</span><span class="p">)</span>
            <span class="n">autograd</span><span class="o">.</span><span class="n">backward</span><span class="p">(</span><span class="n">sum_loss</span><span class="p">)</span>
        <span class="n">trainer</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ce_metric</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="n">l</span> <span class="o">*</span> <span class="n">batch_size</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">cls_loss</span><span class="p">])</span>
        <span class="n">smoothl1_metric</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="n">l</span> <span class="o">*</span> <span class="n">batch_size</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">box_loss</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">50</span><span class="p">:</span>
            <span class="n">name1</span><span class="p">,</span> <span class="n">loss1</span> <span class="o">=</span> <span class="n">ce_metric</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">name2</span><span class="p">,</span> <span class="n">loss2</span> <span class="o">=</span> <span class="n">smoothl1_metric</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'[Epoch {}][Batch {}], Speed: {:.3f} samples/sec, {}={:.3f}, {}={:.3f}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">epoch</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">/</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">btic</span><span class="p">),</span> <span class="n">name1</span><span class="p">,</span> <span class="n">loss1</span><span class="p">,</span> <span class="n">name2</span><span class="p">,</span> <span class="n">loss2</span><span class="p">))</span>
        <span class="n">btic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">INFO</span><span class="p">:</span><span class="n">root</span><span class="p">:[</span><span class="n">Epoch</span> <span class="mi">0</span><span class="p">][</span><span class="n">Batch</span> <span class="mi">49</span><span class="p">],</span> <span class="n">Speed</span><span class="p">:</span> <span class="mf">58.105</span> <span class="n">samples</span><span class="o">/</span><span class="n">sec</span><span class="p">,</span> <span class="n">CrossEntropy</span><span class="o">=</span><span class="mf">1.190</span><span class="p">,</span> <span class="n">SmoothL1</span><span class="o">=</span><span class="mf">0.688</span>
<span class="n">INFO</span><span class="p">:</span><span class="n">root</span><span class="p">:[</span><span class="n">Epoch</span> <span class="mi">0</span><span class="p">][</span><span class="n">Batch</span> <span class="mi">99</span><span class="p">],</span> <span class="n">Speed</span><span class="p">:</span> <span class="mf">58.683</span> <span class="n">samples</span><span class="o">/</span><span class="n">sec</span><span class="p">,</span> <span class="n">CrossEntropy</span><span class="o">=</span><span class="mf">0.693</span><span class="p">,</span> <span class="n">SmoothL1</span><span class="o">=</span><span class="mf">0.536</span>
<span class="n">INFO</span><span class="p">:</span><span class="n">root</span><span class="p">:[</span><span class="n">Epoch</span> <span class="mi">0</span><span class="p">][</span><span class="n">Batch</span> <span class="mi">149</span><span class="p">],</span> <span class="n">Speed</span><span class="p">:</span> <span class="mf">58.915</span> <span class="n">samples</span><span class="o">/</span><span class="n">sec</span><span class="p">,</span> <span class="n">CrossEntropy</span><span class="o">=</span><span class="mf">0.500</span><span class="p">,</span> <span class="n">SmoothL1</span><span class="o">=</span><span class="mf">0.453</span>
<span class="n">INFO</span><span class="p">:</span><span class="n">root</span><span class="p">:[</span><span class="n">Epoch</span> <span class="mi">0</span><span class="p">][</span><span class="n">Batch</span> <span class="mi">199</span><span class="p">],</span> <span class="n">Speed</span><span class="p">:</span> <span class="mf">58.422</span> <span class="n">samples</span><span class="o">/</span><span class="n">sec</span><span class="p">,</span> <span class="n">CrossEntropy</span><span class="o">=</span><span class="mf">0.396</span><span class="p">,</span> <span class="n">SmoothL1</span><span class="o">=</span><span class="mf">0.399</span>
</pre></div>
</div>
<div class="section" id="training-with-amp">
<span id="training-with-amp"></span><h2>Training with AMP<a class="headerlink" href="#training-with-amp" title="Permalink to this headline">¶</a></h2>
<div class="section" id="amp-initialization">
<span id="amp-initialization"></span><h3>AMP initialization<a class="headerlink" href="#amp-initialization" title="Permalink to this headline">¶</a></h3>
<p>In order to start using AMP, we need to import and initialize it. This has to happen before we create the network.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mxnet.contrib</span> <span class="kn">import</span> <span class="n">amp</span>

<span class="n">amp</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">INFO</span><span class="p">:</span><span class="n">root</span><span class="p">:</span><span class="n">Using</span> <span class="n">AMP</span>
</pre></div>
</div>
<p>After that, we can create the network exactly the same way we did in FP32 training.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">net</span> <span class="o">=</span> <span class="n">get_network</span><span class="p">()</span>
<span class="n">net</span><span class="o">.</span><span class="n">hybridize</span><span class="p">(</span><span class="n">static_alloc</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">static_shape</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>For some models that may be enough to start training in mixed precision, but the full FP16 recipe recommends using dynamic loss scaling to guard against over- and underflows of FP16 values. Therefore, as a next step, we create a trainer and initialize it with support for AMP’s dynamic loss scaling. Currently, support for dynamic loss scaling is limited to trainers created with <code class="docutils literal"><span class="pre">update_on_kvstore=False</span></code> option, and so we add it to our trainer initialization.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">trainer</span> <span class="o">=</span> <span class="n">gluon</span><span class="o">.</span><span class="n">Trainer</span><span class="p">(</span>
    <span class="n">net</span><span class="o">.</span><span class="n">collect_params</span><span class="p">(),</span> <span class="s1">'sgd'</span><span class="p">,</span>
    <span class="p">{</span><span class="s1">'learning_rate'</span><span class="p">:</span> <span class="n">lr</span><span class="p">,</span> <span class="s1">'wd'</span><span class="p">:</span> <span class="n">wd</span><span class="p">,</span> <span class="s1">'momentum'</span><span class="p">:</span> <span class="n">momentum</span><span class="p">},</span>
    <span class="n">update_on_kvstore</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="n">amp</span><span class="o">.</span><span class="n">init_trainer</span><span class="p">(</span><span class="n">trainer</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="dynamic-loss-scaling-in-the-training-loop">
<span id="dynamic-loss-scaling-in-the-training-loop"></span><h3>Dynamic loss scaling in the training loop<a class="headerlink" href="#dynamic-loss-scaling-in-the-training-loop" title="Permalink to this headline">¶</a></h3>
<p>The last step is to apply the dynamic loss scaling during the training loop and . We can achieve that using the <code class="docutils literal"><span class="pre">amp.scale_loss</span></code> function.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">mbox_loss</span> <span class="o">=</span> <span class="n">gcv</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">SSDMultiBoxLoss</span><span class="p">()</span>

<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">ce_metric</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="n">smoothl1_metric</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">btic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_data</span><span class="p">):</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">gluon</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">split_and_load</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ctx_list</span><span class="o">=</span><span class="n">ctx</span><span class="p">,</span> <span class="n">batch_axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">cls_targets</span> <span class="o">=</span> <span class="n">gluon</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">split_and_load</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ctx_list</span><span class="o">=</span><span class="n">ctx</span><span class="p">,</span> <span class="n">batch_axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">box_targets</span> <span class="o">=</span> <span class="n">gluon</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">split_and_load</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ctx_list</span><span class="o">=</span><span class="n">ctx</span><span class="p">,</span> <span class="n">batch_axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">autograd</span><span class="o">.</span><span class="n">record</span><span class="p">():</span>
            <span class="n">cls_preds</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">box_preds</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">cls_pred</span><span class="p">,</span> <span class="n">box_pred</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="n">cls_preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cls_pred</span><span class="p">)</span>
                <span class="n">box_preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box_pred</span><span class="p">)</span>
            <span class="n">sum_loss</span><span class="p">,</span> <span class="n">cls_loss</span><span class="p">,</span> <span class="n">box_loss</span> <span class="o">=</span> <span class="n">mbox_loss</span><span class="p">(</span>
                <span class="n">cls_preds</span><span class="p">,</span> <span class="n">box_preds</span><span class="p">,</span> <span class="n">cls_targets</span><span class="p">,</span> <span class="n">box_targets</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">amp</span><span class="o">.</span><span class="n">scale_loss</span><span class="p">(</span><span class="n">sum_loss</span><span class="p">,</span> <span class="n">trainer</span><span class="p">)</span> <span class="k">as</span> <span class="n">scaled_loss</span><span class="p">:</span>
                <span class="n">autograd</span><span class="o">.</span><span class="n">backward</span><span class="p">(</span><span class="n">scaled_loss</span><span class="p">)</span>
        <span class="n">trainer</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ce_metric</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="n">l</span> <span class="o">*</span> <span class="n">batch_size</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">cls_loss</span><span class="p">])</span>
        <span class="n">smoothl1_metric</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="n">l</span> <span class="o">*</span> <span class="n">batch_size</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">box_loss</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">50</span><span class="p">:</span>
            <span class="n">name1</span><span class="p">,</span> <span class="n">loss1</span> <span class="o">=</span> <span class="n">ce_metric</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">name2</span><span class="p">,</span> <span class="n">loss2</span> <span class="o">=</span> <span class="n">smoothl1_metric</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'[Epoch {}][Batch {}], Speed: {:.3f} samples/sec, {}={:.3f}, {}={:.3f}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">epoch</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">/</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">btic</span><span class="p">),</span> <span class="n">name1</span><span class="p">,</span> <span class="n">loss1</span><span class="p">,</span> <span class="n">name2</span><span class="p">,</span> <span class="n">loss2</span><span class="p">))</span>
        <span class="n">btic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">INFO</span><span class="p">:</span><span class="n">root</span><span class="p">:[</span><span class="n">Epoch</span> <span class="mi">0</span><span class="p">][</span><span class="n">Batch</span> <span class="mi">49</span><span class="p">],</span> <span class="n">Speed</span><span class="p">:</span> <span class="mf">93.585</span> <span class="n">samples</span><span class="o">/</span><span class="n">sec</span><span class="p">,</span> <span class="n">CrossEntropy</span><span class="o">=</span><span class="mf">1.166</span><span class="p">,</span> <span class="n">SmoothL1</span><span class="o">=</span><span class="mf">0.684</span>
<span class="n">INFO</span><span class="p">:</span><span class="n">root</span><span class="p">:[</span><span class="n">Epoch</span> <span class="mi">0</span><span class="p">][</span><span class="n">Batch</span> <span class="mi">99</span><span class="p">],</span> <span class="n">Speed</span><span class="p">:</span> <span class="mf">93.773</span> <span class="n">samples</span><span class="o">/</span><span class="n">sec</span><span class="p">,</span> <span class="n">CrossEntropy</span><span class="o">=</span><span class="mf">0.682</span><span class="p">,</span> <span class="n">SmoothL1</span><span class="o">=</span><span class="mf">0.533</span>
<span class="n">INFO</span><span class="p">:</span><span class="n">root</span><span class="p">:[</span><span class="n">Epoch</span> <span class="mi">0</span><span class="p">][</span><span class="n">Batch</span> <span class="mi">149</span><span class="p">],</span> <span class="n">Speed</span><span class="p">:</span> <span class="mf">93.399</span> <span class="n">samples</span><span class="o">/</span><span class="n">sec</span><span class="p">,</span> <span class="n">CrossEntropy</span><span class="o">=</span><span class="mf">0.493</span><span class="p">,</span> <span class="n">SmoothL1</span><span class="o">=</span><span class="mf">0.451</span>
<span class="n">INFO</span><span class="p">:</span><span class="n">root</span><span class="p">:[</span><span class="n">Epoch</span> <span class="mi">0</span><span class="p">][</span><span class="n">Batch</span> <span class="mi">199</span><span class="p">],</span> <span class="n">Speed</span><span class="p">:</span> <span class="mf">93.674</span> <span class="n">samples</span><span class="o">/</span><span class="n">sec</span><span class="p">,</span> <span class="n">CrossEntropy</span><span class="o">=</span><span class="mf">0.391</span><span class="p">,</span> <span class="n">SmoothL1</span><span class="o">=</span><span class="mf">0.397</span>
</pre></div>
</div>
<p>We got 60% speed increase from 3 additional lines of code!</p>
</div>
</div>
<div class="section" id="current-limitations-of-amp">
<span id="current-limitations-of-amp"></span><h2>Current limitations of AMP<a class="headerlink" href="#current-limitations-of-amp" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>AMP’s dynamic loss scaling currently supports only Gluon trainer with <code class="docutils literal"><span class="pre">update_on_kvstore=False</span></code> option set</li>
<li>Using <code class="docutils literal"><span class="pre">SoftmaxOutput</span></code>, <code class="docutils literal"><span class="pre">LinearRegressionOutput</span></code>, <code class="docutils literal"><span class="pre">LogisticRegressionOutput</span></code>, <code class="docutils literal"><span class="pre">MAERegressionOutput</span></code> with dynamic loss scaling does not work when training networks with multiple Gluon trainers and so multiple loss scales</li>
</ul>
<div class="btn-group" role="group">
<div class="download-btn"><a download="amp_tutorial.ipynb" href="amp_tutorial.ipynb"><span class="glyphicon glyphicon-download-alt"></span> amp_tutorial.ipynb</a></div></div></div>
</div>
</div>
</div>
<div aria-label="main navigation" class="sphinxsidebar rightsidebar" role="navigation">
<div class="sphinxsidebarwrapper">
<h3><a href="../../index.html">Table Of Contents</a></h3>
<ul>
<li><a class="reference internal" href="#">Using AMP (Automatic Mixed Precision) in MXNet</a><ul>
<li><a class="reference internal" href="#data-loader-and-helper-functions">Data loader and helper functions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#training-in-fp32">Training in FP32</a><ul>
<li><a class="reference internal" href="#training-with-amp">Training with AMP</a><ul>
<li><a class="reference internal" href="#amp-initialization">AMP initialization</a></li>
<li><a class="reference internal" href="#dynamic-loss-scaling-in-the-training-loop">Dynamic loss scaling in the training loop</a></li>
</ul>
</li>
<li><a class="reference internal" href="#current-limitations-of-amp">Current limitations of AMP</a></li>
</ul>
</li>
</ul>
</div>
</div>
</div><div class="footer">
<div class="section-disclaimer">
<div class="container">
<div>
<img height="60" src="https://raw.githubusercontent.com/dmlc/web-data/master/mxnet/image/apache_incubator_logo.png"/>
<p>
            Apache MXNet is an effort undergoing incubation at The Apache Software Foundation (ASF), <strong>sponsored by the <i>Apache Incubator</i></strong>. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.
        </p>
<p>
            "Copyright © 2017-2018, The Apache Software Foundation
            Apache MXNet, MXNet, Apache, the Apache feather, and the Apache MXNet project logo are either registered trademarks or trademarks of the Apache Software Foundation."
        </p>
</div>
</div>
</div>
</div> <!-- pagename != index -->
</div>
<script crossorigin="anonymous" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
<script src="../../_static/js/sidebar.js" type="text/javascript"></script>
<script src="../../_static/js/search.js" type="text/javascript"></script>
<script src="../../_static/js/navbar.js" type="text/javascript"></script>
<script src="../../_static/js/clipboard.min.js" type="text/javascript"></script>
<script src="../../_static/js/copycode.js" type="text/javascript"></script>
<script src="../../_static/js/page.js" type="text/javascript"></script>
<script src="../../_static/js/docversion.js" type="text/javascript"></script>
<script type="text/javascript">
        $('body').ready(function () {
            $('body').css('visibility', 'visible');
        });
    </script>
</body>
</html>